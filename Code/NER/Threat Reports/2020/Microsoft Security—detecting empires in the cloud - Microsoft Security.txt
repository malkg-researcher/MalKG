Microsoft Security¡ªdetecting empires in the cloud
microsoft.com/security/blog/2020/09/24/gadolinium-detecting-empires-cloud
September 24, 2020
An image of the Microsoft Cyber Defense Operations Center.
Microsoft consistently tracks the most advanced threat actors and evolving attacktechniques. We use these findings to harden our products and platform and share themwith the security community to help defenders everywhere better protect the planet.
Recently, the Microsoft Threat Intelligence Center (MSTIC) observed the evolution ofattacker techniques by an actor we call GADOLINIUM using cloud services and opensource tools to enhance weaponization of their malware payload, attempt to gaincommand and control all the way to the server, and to obfuscate detection. These attackswere delivered via spear-phishing emails with malicious attachments and detected andblocked by Microsoft Defender, formerly Microsoft Threat Protection (MTP), and able tobe detected using Azure Sentinel.
As these attacks were detected, Microsoft took proactive steps to prevent attackers fromusing our cloud infrastructure to execute their attacks and suspended 18 Azure ActiveDirectory applications that we determined to be part of their malicious command &control infrastructure. This action helped transparently protect our customers withoutrequiring additional work on their end.
GADOLINIUM is a nation-state activity group that has been compromising targets fornearly a decade with a worldwide focus on the maritime and health industries. As withmost threat groups, GADOLINIUM tracks the tools and techniques of securitypractitioners looking for new techniques they can use or modify to create new exploitmethods.
Recently, MSTIC has observed newly expanded targeting outside of those sectors toinclude the Asia Pacific region and other targets in higher education and regionalgovernment organizations. As GADOLINIUM has evolved, MSTIC has continued tomonitor its activity and work alongside our product security teams to implementcustomer protections against these attacks.
Historically, GADOLINIUM used custom-crafted malware families that analysts canidentify and defend against. In response, over the last year GADOLINIUM has begun tomodify portions of its toolchain to use open-source toolkits to obfuscate their activity andmake it more difficult for analysts to track. Because cloud services frequently offer a freetrial or one-time payment (PayGo) account offerings, malicious actors have found ways totake advantage of these legitimate business offerings. By establishing free or PayGoaccounts, they can use cloud-based technology to create a malicious infrastructure thatcan be established quickly then taken down before detection or given up at little cost.
The following GADOLINIUM technique profile is designed to give security practitionerswho may be targeted by this specific actor¡¯s activity insight and information that will helpthem better protect from these attacks.
2016: Experimenting in the cloud
GADOLINIUM has been experimenting with using cloud services to deliver their attacksto increase both operation speed and scale for years. The image in Figure 1 is from aGADOLINIUM controlled Microsoft TechNet profile established in 2016. This early use ofa TechNet profiles¡¯ contact widget involved embedding a very small text link thatcontained an encoded command for malware to read.
An image of a GADOLINIUM controlled Microsoft TechNet profile established in 2016. 
Figure 1: GADOLINIUM controlled TechNet profile with embedded malware link.
2018: Developing attacks in the cloud
In 2018 GADOLINIUM returned to using Cloud services, but this time it chose to useGitHub to host commands. The image in Figure 2 shows GitHub Commit history on aforked repository GADOLINIUM controlled. In this repository, the actors updatedmarkdown text to issue new commands to victim computers. MSTIC has worked with ourcolleagues at GitHub to take down the actor accounts and disrupt GADOLINIUMoperations on the GitHub platform.
An image of a GitHub repository controlled by GADOLINIUM.
Figure 2: GitHub repository controlled by GADOLINIUM.
2019-2020: Hiding in plain sight using open source
GADOLINIUM¡¯s evolving techniquesTwo of the most recent attack chains in 2019 and 2020 were delivered fromGADOLINIUM using similar tactics and techniques. Below is a summary view of howthese attacks techniques have evolved followed by a detailed analysis of each step thatsecurity practitioners can use to better understand the threat and what defenses toimplement to counter the attacks.
A summary view of how these attacks techniques have evolved.
WeaponizationIn the last year, Microsoft has observed GADOLINIUM migrate portions of its toolchaintechniques based on open source kits. GADOLINIUM is not alone in this move. MSTIChas noticed a slow trend of several nation-state activity groups migrating to open sourcetools in recent years. MSTIC assesses this move is an attempt to make discovery andattribution more difficult. The other added benefit to using open-source types of kits isthat the development and new feature creation is done and created by someone else at nocost. However, using open source tools isn¡¯t always a silver bullet for obfuscation andblending into the noise.
Delivery & Exploitation (2019)In 2019, we discovered GADOLINIUM delivering malicious Access database files totargets. The initial malicious file was an Access 2013 database (.accde format). Thisdropped a fake Word document that was opened along with an Excel spreadsheet and afile called.mm.accdb.core.which was subsequently executed. The file.mm.accdb.core.is aVBA dropper, based on the.CactusTorch VBA module, which loads a .NET DLL payload,sets configuration information, and then runs the payload. Defender for Office 365detects and blocks malicious Microsoft Access database attachments in email. A redactedexample of the configuration is displayed below.
An image showing the VBA setting config and calling the 'Run' function of the payload.
Figure 3: VBA setting config and calling the ¡°Run¡± function of the payload
Command and Control (2019)Having gained access to a victim machine the payload then uses attachments to OutlookTasks as a mechanism for command and control (C2). It uses a GADOLINIUM-controlledOAuth access token with login.microsoftonline.com and uses it to call the Outlook TaskAPI to check for tasks. The attacker uses attachments to Outlook tasks as a means ofsending commands or .NET payloads to execute; at the victim end, the malware adds theoutput from executing these commands as a further attachment to the Outlook task.
Interestingly, the malware had code compiled in a manner that doesn¡¯t seem to be used inthe attacks we saw. In addition to the Outlook Tasks API method described above, theextra code contains two other ways of using Office365 as C2, via either the OutlookContacts API (get and add contacts) or the OneDrive API (list directory, get and add afile).
Actions on Objective (2019)GADOLINIUM used several different payloads to achieve its exploitation or intrusionobjectives including a range of PowerShell scripts to execute file commands(read/write/list etc.) to enable C2 or perform SMB commands (upload/download/deleteetc.) to potentially exfiltrate data.
LazyCat, one of the tools used by GADOLINIUM, includes privilege escalation andcredential dumping capability to enable lateral movement across a victim network.Microsoft Defender for Endpoint detects the privilege escalation technique used:
An image ofMicrosoft Defender ATP alert of detected escalation of privilege attempt. 
LazyCat performs credential dumping through usage of the.MiniDumpWriteDumpWindows API call, also detected by Microsoft Defender for Endpoint:
An image of Microsoft Defender ATP alert of detected credential dumping activity.
Delivery (2020)In mid-April 2020 GADOLINIUM actors were detected sending spear-phishing emailswith malicious attachments. The filenames of these attachments were named to appeal tothe target¡¯s interest in the COVID-19 pandemic. The PowerPoint file (20200423-sitrep-92-covid-19.ppt),.when run, would drop a file,.doc1.dotm. Similarly, to the 2019 example,Microsoft Defender for Office detects and blocks emails with these malicious PowerPointand Word attachments.
Command and Control (2020)The malicious doc1.dotm had two payloads which run in succession.
The first payload turns off a typecheck.DisableActivitySurrogateSelectorTypeCheck .which the second stageneeds.as discussed in this blog.
The second payload loads an embedded .Net binary which downloads, decrypts +runs a .png file.

The .png is actually PowerShell which downloads and uploads fake png files using theMicrosoft Graph API tohttps://graph.microsoft.com/v1.0/drive/root:/onlinework/contact/$($ID)_1.png:/content.where $ID is the ID of the malware. The GADOLINIUM PowerShell is a modifiedversion of the opensource.PowershellEmpire toolkit.
Actions on Objectives (2020)The GADOLINIUM PowerShell Empire toolkit allows the attacker to load additionalmodules to victim computers seamlessly via Microsoft Graph API calls. It providesa.command and control module that uses the attacker¡¯s Microsoft OneDrive account toexecute commands and retrieve results between attacker and victim systems. The use ofthis PowerShell Empire module is particularly challenging for traditional SOC monitoringto identify. The attacker uses an Azure Active Directory application to configure a victimendpoint with the permissions needed to exfiltrate data to the attacker¡¯s own MicrosoftOneDrive storage. From an endpoint or network monitoring perspective the activityinitially appears to be related to trusted applications using trusted cloud service APIs and,in this scenario,, no OAuth permissions consent prompts occur. Later in this blog post, wewill provide additional information about how Microsoft proactively prevents attackersfrom using our cloud infrastructure in these ways.
Command and Control¡ªServer compromiseGADOLINIUM campaigns often involve installing web shells on legitimate web sites forcommand and control or traffic redirection. Microsoft Defender for Endpoint detects webshells by analyzing web server telemetry such as process creation and file modifications.Microsoft blogged earlier in the year on the use of web shells by multiple groups.and howwe detect such activities.
Microsoft Defender ATP alerts of suspicious web shell attacks
Microsoft Defender ATP alerts of suspicious web shell attacks.
Figure 6: Microsoft Defender for Endpoint alerts of suspicious web shell attacks.
Web shell alerts from Microsoft Defender for Endpoint can be explored in Azure Sentineland enriched with additional information that can give key insights into the attack.MSTIC¡¯s Azure Sentinel team recently published a blog outlining how such insights canbe derived by analyzing events from the W3CIISLog.
Microsoft¡¯s proactive steps to defend customersIn addition to detecting many of the individual components of the attacks throughMicrosoft¡¯s security products and services such as Microsoft Defender for Endpoint andfor Microsoft Defender for Office as described above, we also take proactive steps toprevent attackers from using our cloud infrastructure to perpetrate attacks. As a cloudprovider, Microsoft is uniquely positioned to disrupt this attacker technique. ThePowerShell Empire scenario is a good example of this. During April 2020, the MicrosoftIdentity Security team suspended 18 Azure Active Directory applications that wedetermined to be part of GADOLINIUM¡¯s PowerShell Empire infrastructure (ApplicationIDs listed in IOC section below). Such action is particularly beneficial to customers assuspending these applications protects all customers transparently without any actionbeing required at their end.)
As part of Microsoft¡¯s broader work to foster a secure and trustworthy app ecosystem, weresearch and develop detection techniques for both known and novel maliciousapplications. Applications exhibiting malicious behavior are quickly suspended to ensureour customers are protected.
GADOLINIUM will no doubt evolve their tactics in pursuit of its objectives. As thosethreats target Microsoft customers, we will continue to build detections and implementprotections to defend against them. For security practitioners looking to expand your ownhunting on GADOLINIUM, we are sharing the below indicators of compromise (IOCs)associated with their activity.
List of related GADOLINIUM indicators
Hashes from malicious document attachments
faebff04d7ca9cca92975e06c4a0e9ce1455860147d8432ff9fc24622b7cf675f61212ab1362dffd3fa6258116973fb924068217317d2bc562481b037c806a0a
Actor-owned email addresses
Chris.sukkar@hotmail.comPhillipAdamsthird@hotmail.comsdfwfde234sdws@outlook.comjenny1235667@outlook.comfghfert32423dsa@outlook.comsroggeveen@outlook.comRobertFetter.fdmed@hotmail.comHeather.mayx@outlook.com
Azure Active Directory App IDs associated with malicious apps
ae213805-a6a2-476c-9c82-c37dfc0b6a6cafd7a273-982b-4873-984a-063d0d3ca23d58e2e113-b4c9-4f1a-927a-ae29e2e1cdeb8ba5106c-692d-4a86-ad3f-fc76f01b890dbe561020-ba37-47b2-99ab-29dd1a4312c4574b7f3b-36da-41ee-86b9-c076f999b1de941ec5a5-d5bf-419e-aa93-c5afd0b01effd9404c7d-796d-4500-877e-d1b49f02c9df67e2bb25-1f61-47b6-9ae3-c6104e5878829085bb9e-9b56-4b84-b21e-bd5d5c7b0de0289d71ad-54ee-44a4-8d9a-9294f19b0069a5ea2576-4191-4e9a-bfed-760fff616fbf802172dc-8014-42a9-b765-133c07039f9ffb33785b-f3f7-4b2b-b5c1-f688d3de1bdec196c17d-1e3c-4049-a989-c62f7afaf7f379128217-d61e-41f9-a165-e06e1d672069f4a41d96-2045-4d75-a0ec-9970b0150b5288d43534-4128-4969-b5c4-ceefd9b31d02
To learn more about Microsoft Security solutions visit our website.. Bookmarkthe.Security blog.to keep up with our expert coverage on security matters. Also, follow usat.@MSFTSecurity.for the latest news and updates on cybersecurity.





