APT28 Delivers Zebrocy Malware Campaign usingNATO Theme as Lure
quointelligence.eu/2020/09/apt28-zebrocy-malware-campaign-nato-theme
September 22, 2020
 Executive Summary
On 9 August,.QuoIntelligence detected an ongoing APT28 campaign, which likelystarted on 5 August.
The malware used in the attack was the Zebrocy Delphi version. All the artifacts hadvery low Anti-Virus (AV) detection rates on VirusTotal when they were firstsubmitted.
At the time of the discovery, the C2 infrastructure hosted in France was still live.
The campaign used NATO＊s upcoming trainings as a lure.
The campaign targeted a specific government body in Azerbaijan, however; it islikely that attackers also targeted NATO members or other countries involved inNATO exercises.
Analysis revealed interesting correlations with ReconHell/BlackWater attack, whichwe uncovered in August.
As part of our responsible disclosure, we reported our findings to French authoritiesfor taking down the C2, and to NATO for their awareness.

Introduction
On 9 August, QuoIntelligence disseminated a Warning to its government customers abouta new APT28 (aka Sofacy, Sednit, Fancy Bear, STRONTIUM, etc.) campaign targetinggovernment bodies of NATO members (or countries cooperating with NATO). Inparticular, we found a malicious file uploaded to VirusTotal, which ultimately drops aZebrocy malware and communicates with a C2 in France. After our discovery, wereported the malicious C2 to the French law enforcement as part of our responsibledisclosure process.
Zebrocy is a malware used by APT28 (also known as Sofacy), which was reported bymultiple security firms[1][2][3][4][5][6] in the last two years.
Finally, our investigation concluded that the attack started on 5 August and targeted atleast a government entity located in the Middle East. However, it is highly likely thatNATO members also observed the same attack.
Technical Analysis
File NameFile Name Course 5 每 16 October 2020.zipxCourse 5 每 16 October 2020.zipx 
SHA256 e6e19633ba4572b49b47525b5a873132d-feb432f075fbba29831f1bc59d5885d
 
First Submis-sion to VT 2020-08-05T12:28:27 
First AV de-tetction rate Really Low (3/61) 

At a first look, the sample seems to be a valid JPEG image file:.

In fact, if the file is renamed as a JPG, the Operating System will show the logo of theSupreme Headquarters Allied Powers Europe (SHAPE), which is the NATO＊s AlliedCommand Operations (ACO) located in Belgium.

However, further analysis revealed the sample as having a Zip file concatenated. Thistechnique works because JPEG files are parsed from the beginning of the file and someZip implementations parse Zip files from the end of the file (since the index is locatedthere) without looking at the signature in the front.
The technique is also used by threat actors to evade AVs, or other filtering systems sincethey might mistake the file for a JPEG and skip it. Interestingly, in order to trigger thedecompression of the file on Windows after the user clicks on it, the following conditionsneed to be met: .a) the file must be correctly named .zip(x); b) the file needs to be openedwith WinRAR. The file will show an error message.claiming it is corrupted if the targetedvictim uses WinZip or the default Windows utility.
After decompressing the appended ZIP file, the following two samples are dropped:
Course 5 每 16 October 2020.exe (Zebrocy malware). . . . . . . . . . . . . . . . . SHA256:.aac3b1221366cf7e4421bdd555d0bc33d4b92d6f65fa58c1bb4d8474db883fec .

.Course 5 每 16 October 2020.xls (Corrupted file). . . . . . . . . . . . . . . . . . . . . . . .SHA256:b45dc885949d29cba06595305923a0ed8969774dae995f0ce5b947b5ab5fe185

Considering the lure uses a NATO image, the attackers likely picked the filenames inorder to leverage upcoming NATO courses in October 2020. Additionally, the Excel file(XLS) is corrupted and cannot be opened by Microsoft Excel, it contains 每 what seems tobe 每 information about military personnel involved in the military mission ※AfricanUnion Mission for Somalia§. The long list of information includes names, ranks, unit,arrival/leave dates, and more.

To note, QuoIntelligence was not able to determine if the information contained in the fileis legitimate or not.
One of the hypotheses explaining the corrupted file is an intentional tactic of the attacker.The rationale could be that the attacker makes the user attempt to first open the XLS file,and then open the .exe with the same filename as a second try. The .exe file has a PDFicon, so if file extensions are not shown, targeted users might be lured into opening theexecutable.
File Name Course 5 每 16 October 2020.exe 
SHA256 aac3b1221366cf7e4421bdd555d0bc33d4b92d6f65-fa58c1bb4d8474db883fec
 
First Submis-sion to VT 2020-08-05T18:33:39 
First AV detec-tion rate Really Low (9/70) 

The sample analyzed is a Delphi executable. Since 2015, multiple researchers havealready covered Zebrocy Delphi versions in-depth. Interestingly, last Zebrocyobservations seemed to suggest a discontinuity of the Delphi versions in favor of a newone written in Go language.
Behavior Analysis
Once executed, the sample copies itself into%AppData%\Roaming\Service\12345678\sqlservice.exe.by adding 160 random bytes tothe new file. This padding is used to evade hash-matching security controls, since thedropped malware will always have a different file hash value.
Next, the malware creates a new scheduled task, and it is executed with the /s.parameter

The task runs regularly and tries to POST stolen data (e.g. screenshots) tohxxp://194.32.78[.]245/protect/get-upd-id[.]php

At a first glance, the data seems to be obfuscated and encrypted. Another request lookslike this:

The heading number 12345678 (the original eight digits were redacted) seems to beconstant, suggesting its use as a unique ID of the infected machine. Notably, the samenumber is also used by the malware while creating the folder that contains sqlservice.exe
Letting the sample talk to its actual C2 on the Internet did not change its actual behaviorduring our analysis. The malware sends POST requests about once per minute withoutgetting a response back. Additionally, the server closes the connection after waiting forabout 10 more seconds. It is possible that this unresponsive behavior is due to the C2determining the infected machine as not interesting.
Lastly, the network traffic generated to the C2 triggers the following Emerging Threats(ET) IDS rule:
ET TROJAN Zebrocy Screenshot Upload§ (SID: 2030122)

Victimology and Attribution
QuoIntelligence concludes with medium-high confidence that the campaign targeted aspecific government body, at least in Azerbaijan. Although Azerbaijan is not a NATOmember, it closely cooperates with the North-Atlantic organizations and participates inNATO exercises. Further, the same campaign very likely targeted other NATO membersor countries cooperating with NATO exercises.
By analyzing the Tactics, Techniques and Procedures (TTPs), the targeting, and the themeused as a lure, we have high confidence in attributing this attack to the well-knownAPT28/Zebrocy TTPs disclosed by the security community in the last year.
An Interesting Coincidence?
Although we could not find any strong causation link yet or solid technical link betweenthe two attacks, it should be noted the following points correlating with the ReconHellcatcampaign we uncovered on August 11:
Both the compressed Zebrocy malware and the OSCE-themed lure used to drop theBlackWater backdoor were uploaded the same day, on 5 August.
Both samples were uploaded by the same user in Azerbaijan and are highly likely bythe same organization.
Both attacks happened in the same timeframe.
OSCE and NATO are both organizations that have been targeted (directly orindirectly) by APT28 in the past.
The victimology we identified for the ReconHellcat campaign is in line with the onetargeted by the Zebrocy attack (i.e. similar type of government bodies). The type oforganizations targeted by both attacks is also in line with known APT28victimology.
We assessed ReconHellcat as a high-capability APT group, like APT28.


Citations
[1] ESET, A1, April 2018, Sednit update: Analysis of Zebrocy
[2] Palo Alto, B1, June 2018, Sofacy Group＊s Parallel Attacks
[3] Kaspersky, A1, October 2018, Shedding Skin 每 Turla＊s Fresh Faces
[4] Kaspersky, A1, Janurary 2019, A Zebrocy Go Downloader
[5] Kaspersky, A1, January 2019, GreyEnergy＊s overlap with Zebrocy
[6] Kaspersky, A1, June 2019, Zebrocy＊s Multilanguage Malware
Appendix I 每 IOCs
hxxp://194.32.78.245/protect/get-upd-id.php
Course 5 每 16 October 2020.zipx
6e89e098816f3d353b155ab0f3377fe3eb3951f45f8c34c4a48c5b61cd8425aa
Course 5 每 16 October 2020.xls (Corrupted file)
b45dc885949d29cba06595305923a0ed8969774dae995f0ce5b947b5ab5fe185
Course 5 每 16 October 2020.exe (Zebrocy malware)
aac3b1221366cf7e4421bdd555d0bc33d4b92d6f65fa58c1bb4d8474db883fec
Additional Zebrocy malware variants on VT 
fae335a465bb9faac24c58304a199f3bf9bb1b0bd07b05b18e2be6b9e90d72e6
.eb81c1be62f23ac7700c70d866e84f5bc354f88e6f7d84fd65374f84e252e76b
MITRE ATT&CK
TACTIC TECHNIQUE 
Execution T1047: Windows Management Instrumentation 
DefenseEvasion T1140: Deobfuscate/Decode Files or Information 
Discovery T1083: File and Directory Discovery                                               T1135: Network Share DiscoveryT1120: Peripheral Device DiscoveryT1057: Process DiscoveryT1012: Query Registry                                                                     T1082: System Information DiscoveryT1016: System Network Configuration Discovery                       T1049: System Network Connections DiscoveryT1033: System Owner/User Discovery                                           T1124: System Time Discovery 
Collection T1560: Archive Collected DataT1119: Automated CollectionT1113: Screen Capture 
Commandand Control T1105: Ingress Tool Transfer 
Exfiltration T1041: Exfiltration Over C2 Channel 

Do you want to stay.informed of cyber and geopolitical threats targeting yourorganization? Are you interested in receiving exclusive and unpublished intelligence?
Get in touch!
Join our Newsletter!
To be the first to know when we publish similar blog posts, Weekly IntelligenceSummaries, or other exciting happenings, subscribe to our newsletter today! Onlybusiness emails will be approved.
Subscribe






