ByGaborSzappanos,PrincipalResearcher,SophosLabs July2013 InarecentSophosLabsarticleaboutthePlugX malwarefamily[A],weconcluded withthesewords: There is no doubt that PlugX development will go on, and new features and tricks will be introduced. We'll keep an eye on them, and if any interesting or important new features appear, we'll be sure to let you know. Fastforwardjustundertwomonths,andwe'rereadytotellyouthenextstagein thisongoingsaga. Themalwarefamilywe'llbelookingatinthisreportisknownasSmoaler,andit sharesmanyfeatureswithPlugX,notablythat: . Smoalerreliesonthesamevulnerability,CVE-2012-0158.[B] . Smoalerusesthesameexploitshellcode. . Smoalerusessimilarvisualdistractions,ordecoys,withaTibetantheme. . Smoalerusesthesameinitial malwaremodulestoinitiateinfection. Thereafter,thenewmalwarefollowsadifferentpathtothePlugX sampleswe lookedatlasttime. Weshallanalysethe¡°whathappensnext¡±componentof Smoalerlateron. Toclarifytheterminologywehaveusedabove,rememberthat: . Avulnerabilityisasoftwarebugthatcouldpotentiallybeabusedtomake yourcomputerbehaveinsecurely. . Anexploitisareal-worldtrickbywhichavulnerabilitycanbeactivatedto bypasssecurity. . Shellcodeisrunnableprogramcodedeliveredinsideafilethatissupposed tobeplaindata,andthereforeimplicitlysafe,butthatcanbeexecuted withouttheuser'sknowledgeorconsentbyexploitingavulnerability. . Initialmalwaremodules,alsocalleddroppers,aremalwarecomponents, oftendeliveredoractivatedbyshellcode,usedtodeliverthefullmalware,or payload,thattheattackerwantstoinstall. ý 2013 Sophos Ltd. All rights reserved. Visit www.sophos.com/legal for more information. 1 HowSmoalerarrives TheSmoalersamplesseenbySophosLabswereallpackagedintofileswiththe extensions.DOC or.DOCX.Theseextensionsusuallydenotefilesspecificto MicrosoftWordthatwerecreatedbyMicrosoftWord. Despitetheextensions,however,allthefileswereactuallyinRichTextFormat (RTF),atext-basedfileformatforrepresentingdocuments. WeassumethattheattackerschoseRTFbecauseitstextstructuremakesiteasier tomanipulatetocreateaworkingexploitfortheCVE-2012-0158vulnerability. AswithPlugX,theSmoalerfilesarrivedwithTibetan-themedsubjectlines: ý 2013 Sophos Ltd. All rights reserved. Visit www.sophos.com/legal for more information. 2 If youopenaninfecteddocumentonanunpatched,unprotectedcomputer,the shellcodeinthedocumentwillactivateandrun. Afterinfectingyourcomputer,theshellcodeloadsanewcopyof Wordtodisplaya decoydocumentthatishiddeninsidethemaliciousfile. Youwillnoticeonlynoticeabrief flickerwhentheoldinstanceof Wordclosesand thenewonewiththedecoyopens. Thedecoydocumentsareallunexceptional,uninfecteddocumentswithcontent thatmatchesthefilenamesgiventothemaliciousRTFs.(SeeFig2.) ý 2013 Sophos Ltd. All rights reserved. Visit www.sophos.com/legal for more information. 3 Inpreparingthedecoyfordisplay,themalwareoverwritestheinfectedRTFfile withthecontentsof thedecoy(whichisinDOCformat),thusremovingoneuseful pieceof evidencethatmightotherwisehelppinpointthesourceof infection. Theshellcode TheexecutablecodethatkicksoffinfectionisthesameaswasusedinPlugX, beingbyte-forbyteidentical(seeFig3) totheshellcodefrom PlugX 6.0[A]. .......Thisshellcodeisunusualforitsuseof LZNT1compressionfortheembedded executablepayload.ThistechniquehasnotbeenobservedinanyotherAPT (AdvancedPersistentThreat)attacks. TheshellcodedecompressesanembeddedPEfile,writesitintothe%TEMP% folder withthenameDW20.DLL (thismimicsthefilenameusedbytheDr.Watsonutility onWindowsthatpopsupwhenaprogramcrashes),andrunsit. First-stagedropper Thefirst-stagepayloadcreatedbytheshellcodecontainsanotherprogramfile embeddedasdata. Itlocatesthisinitsownexecutablefile,dropsittodisk(whichiswherethename droppercomesfromforthissortof malwarecomponent),andruns it. ý 2013 Sophos Ltd. All rights reserved. Visit www.sophos.com/legal for more information. 4 Therearetwomainsortsof dropper,detectedbySophosasTroj/Plugx-I and Troj/Plugx-K.(SeeFig4.) Thenamesreflectthesimilarity,thusfar,toearlierPlugX malware. ButwhathappensnextisquitedifferentfromaPlugX attack,whichiswhythis malwarehasbeengiventhegeneralnameSmoaler,ratherthanPlugX. The intermediateinfector ThetemporaryfiledroppedbyDW20.DLL containsacompressedDLL(dynamiclink library:aspecialsortof programfile) storedinitsresources.Thiscompressed programisunpackedusingcodebuiltonthestack. ThiscomponentdecodestheCommand-and-Control(C&C) servernamesthatthe finalmalwarewilluse,andsavesthemtotheregistryentry HKCU\Software\ Microsoft\Windows Media\XC. (SeeFig5.) C&Cserversarethecomputerstowhichinfectedcomputers,oftencalledbots or zombies,connectinordertofetchinstructionsonwhattodonext.PuttingtheC&C servernamesintheregistry,ratherthaninthezombieexecutableitself,means thatif theuserbecomessuspiciousandsubmitsthemalwarefiletoasecurity vendor,thelocationsof theC&Cserverswillnotberevealed. Thedataintheregistryentryisobscuredbyflippingtheleastsignificantbitof the non-zerobytes(i.e.XORingthemwith0x01).Thisprovidesalightdisguiseagainst aninquisitiveuser. ý 2013 Sophos Ltd. All rights reserved. Visit www.sophos.com/legal for more information. 5 AfterstoringtheC&Cnamesintheregistry,theintermediateinfectorloadsthe droppedDLLusingtheLoadLibrary() WindowsAPI call. Theintermediateinfectorisdeletedfromthesystemafterexecution. Mainmalwarecomponent TheDLLdroppedbytheintermediateinfectoristheprincipalcomponentof Smoaler. TheDLLscreatedduringinfectionarevariableinsize,andhuge,rangingfrom20 MBytesto50MBytes. Thisisnotbecausetheyarecomplexandpackedwithfunctionality:theuseful contentof Smoalerislessthan40KBytes.Thebulkof eachDLLconsistsof a number(twotosix) binaryresourcesof 5MBytesto10MByteseach.These resourcesarefilledwithzerobytes,entirelyforthepurposeof bulkingupthefile. Weassumethatthepurposeof deliberatelybloatingthemainDLListodisguiseits originalsource,sinceevenasuspicioususermightnotconnectamulti-megabyte DLLwiththeoriginalinfectiousRTFof afewhundredkilobytes.(TheoriginalRTFis alsoreplacedwiththedecoyDOCfileafterinfection,furtherdivertingattention fromtheoriginof themalware.) ý 2013 Sophos Ltd. All rights reserved. Visit www.sophos.com/legal for more information. 6 WhentheDLLfirstruns,itinstallsitself permanentlyintotwoplacesonthe victim'scomputer: . C:\Documents and Settings\All Users\Application Data\Microsoft\Windows\Burn\%COMPUTERNAME%.dll (%COMPUTERNAME% isgeneratedbyqueryingthenameof thecomputer.) . C:\Documents and Settings\All Users\Application Data\Microsoft\Windows\LiveUpdata_Mem\%RANDOM%.dll (The%RANDOM% partof thenameisvariable,e.g.B6go3s_One.dll or7n5HjV.dll.) Twoorthreecopiesof theDLLaredropped.Theytypicallydifferinsize,because thezero-byteresourcepaddingmayvaryineachfile. TheDLLisaddedasaregistryvaluecalled%COMPUTERNAME% intheregistrykey HKCU\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer\run. Thisprovideswhatisknownaspersistence,meaningthatthemalwareis automaticallyre-loadedeverytimethevictimrebootsorlogson. (SeeFig6.) NotethatSmoalerislaunchedusingtheWindowsutilityrundll32.exe,because DLLscannotexecuteontheirown.Theyrequireahostprograminsidewhichto run. WhenconnectingtoitsC&Cservers,Smoalerinjectsitself intotheprocess IEXPLORE.EXE.Thisisacommontrickusedbymalwaretomakeitstrafficappear tooriginatefromabrowser,thusarousingmuchlesssuspicion. Whilerunning,however,Smoalerkeepsalookoutforprocessescalledvsserv.exe, fsdfwd.exe,AvastSvc.exe,uiWatchDog.exe,andavp.exe. Itavoidsinjecting itself intoInternetExplorerif anyof themareactive. ý 2013 Sophos Ltd. All rights reserved. Visit www.sophos.com/legal for more information. 7 Theseprocessesbelongtovarioussecurityproducts,sothisisamalware precautionoftenjocularlycalledanti-anti-virus,intendedtoavoidsuspicious activitythatmightattracttheattentionof securitysoftware. Afterinstallingitself,SmoalerattemptstoconnecttoitsC&Cservers.Thedomain namesitusesarealreadyknownfromearlierTibet-relatedmalwareattacks: dtl.dnsd.me,dtl.eauto.com anddtl6.moo.com. Whathappensnext? Unfortunately,wecan'tsaypreciselyhowaninfectedcomputerwillbehaveif Smoalergetsthisfar. ThatisbecausethecontentthattheprimarySmoalerDLLfetchesfromitsC&C serversiswhatevermalwaretheattackerschoosetoserveupnext. Worsestill,theprogramsdownloadedbySmoalerarenotinregularEXEorDLL format. Firstly,thedownloadsareencrypted;secondly,theirheadersarestrippedoffso that,evendecrypted,theyarenotimmediatelyobviousasprograms;thirdly,they areloadeddirectlyinto,andrundirectlyfrom,memory,ratherthenbeingwritten todiskandlaunchedviatheWindowsAPI. Thatmeansthatif youkillofftheSmoalerprocessanddeleteitsprimary executable,asyouwillalmostcertainlywanttodoif youfindoutthatyouare infected,youmaynolongerhaveacompletecopyof themalwaretosubmitfor analysis. Inthisway,theSmoalerauthorsavoidshowingallthecardsintheirhandatonce, inthehopeof stayingonestepahead. However,thismulti-stageapproachalsohasasignificantdisadvantagefor cybercriminals:therearenowmultiplepointsintheattackatwhichyoucanspot ananomaly,intervene,andwin. Preventionisbetterthancure MalwarelikeSmoalerisastrongreminderof whyproactivityandpreventionare betterthancure:onceyouareinfected,itcanbehardtogobackandunravel whathappened,becauseof thetricksthatthemalwareusesalongtheway. ý 2013 Sophos Ltd. All rights reserved. Visit www.sophos.com/legal for more information. 8 References [A] http://nakedsecurity.sophos.com/inside-the-plugx-malware [B] http://www.cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2012-0158 Forfurthersecurityinformation http://www.sophos.com/why-sophos/our-people/technical-papers.aspx http://nakedsecurity.sophos.com/ http://podcasts.sophos.com/ ý 2013 Sophos Ltd. All rights reserved. Visit www.sophos.com/legal for more information. 9 