Trend Micro About TrendLabs Security Intelligence Blog Search:GotoÿHomeCategoriesHome . Malware .  Latest Trickbot Campaign Delivered via Highly Obfuscated JS File Latest Trickbot Campaign Delivered via HighlyObfuscated JS File Posted on:August 5, 2019 at 5:03 am Posted in:Malware, SpamAuthor: Trend Micro by Noel Anthony Llimos and Michael Jhon O.aza (Threats Analysts) We have been tracking Trickbot banking trojan activity and recently discovered a variant of the malware(detected by Trend Micro as TrojanSpy.Win32.TRICKBOT.TIGOCDC) from distributed spam emails thatcontain a Microsoft Word document with enabled macro. Once the document is clicked, it drops a heavilyobfuscated JS .le (JavaScript) that downloads Trickbot as its payload. This malware also checks for thenumber of running processes in the affected machine; if it detects that it¡¯s in an environment with limited Aside from its information theft capabilities, it also deletes .les located in removable and network drives thathave particular extensions, after which the .les are replaced with a copy of the malware. Based on ourtelemetry, this Trickbot campaign has affected the United States the most. It has also distributed spam toChina, Canada, and India. Figure 1. Infection chain In a sample email, the spam purports to be a subscription noti.cation involving advertising providers, eventelling the user that it submitted an application for a three-year subscription and settled a sum of money withthe sender. The mail then explains that several more fees will be charged to the user¡¯s card in the comingtransactions. It ends by prompting the user to see the attached document for all the settlement andsubscription information. The document in question contains the malicious script. The distributed Word document presents the user with the following noti.cation (see Figure 2) that states thecontent can be viewed by enabling macro content. It¡¯s worth noting that the document hides the JS script inthe document itself and not in the macro. It does this by disguising the script through the same font color asthe document background. Figure 2. Document asking users to enable macro The script is obfuscated and contains different functions. In order to decrypt a function, it will use anotherfunction that will convert it to a single character. Figure 3. Function for decryption Upon successfully deobfuscating the .le, we were able to analyze it and observed some interesting behaviors.Upon execution, it will display a fake Microsoft error to trick the user with an error message that pops upafter enabling the macro. But actually, the JS .le is already running in the background. Figure 4. Fake Microsoft error For persistence, the malware creates a copy of itself into the Startup folder as Shell.jse. The JS .le also checks for running processes ¡ª what¡¯s particularly notable is the malware¡¯s anti-analysis or evasioncharacteristic, which checks for the total number of all the running processes in the victim¡¯s machine, whichmeans it will not proceed with its execution if there are not enough processes running. If the running processes are under 1,400 characters (length of the string), the malware assumes it to be anindicator that it is running in a virtual or sandbox environment. It will also check for the existence ofprocesses usually used for analysis. Aside from these, the malware inspects if the environment it runs inrelates to speci.c usernames. Figure 5. A snippet of checked processes and usernames Figure 6. Code error shown if anything matches the check AgentSimulator.exeB.exe BehaviorDumperBennyDB.exectfmon.exe DFLocker64 FrzState2k gemu . ga.exeiexplore.exeImmunityDebuggerLOGSystem.Agent.Service.exelordPE.exe ProcessHacker procexpProcmon PROCMON Proxi.er.exe tcpdumpVBoxService VBoxTray.exevmtoolsd vmware VzService.exe windanr.exe Wireshark Upon further analysis, we¡¯ve also compiled the usernames the malware checks for based on the followingstrings: EmilyHAPUBWS Hong LeeJohnson milozs Peter Wilson SystemIT | adminVmRemoteGuest WIN7 . TRAPS For the malware¡¯s payload, it will connect to the URL hxxps://185[.]159[.]82[.]15/hollyhole/c644[.]php then checks for the .le to be downloaded. If it is an executable .le, it will save the .le to %Temp% as {random}.exe and execute it afterwards. If the .le is not an executable, it will then save it as {random}.cro in the same folder. The .cro .le will then be decoded using certutil.exe, saved as {random}.exe in the same directory, and executed. Upon further research, we discovered that the downloaded .exe .le is a variant of theTrickbot malware. Figure 7. The .le is saved, random names get generated, and .cro is decoded using certutil.exe Aside from stealing system information such as OS, CPU, and memory information; user accounts; installedprograms and services; IP con.guration; and network information (con.guration, users, and domain settings),this Trickbot variant also gathers the following credentials and information from applications and internetbrowsers. Application credentials Browser credentials and information (Google Chrome,Internet Explorer, Microsoft Edge, and Mozilla Filezilla Firefox)Microsoft Outlook PuTTy Auto.lls Remote Desktop (RDP) Billing info dataVNC Browsing historyWinSCP Credit card data HTTP POST responsesInternet cookies Usernames and passwords This malware also uses a point-of-sale (PoS) extraction module called ps.n32, which identi.es PoS-relatedterms located in the domain of interest. The module uses LDAP queries to search for PoS information onmachines with the following substrings: *ALOHA* *BOH* *CASH* *LANE* *MICROS* *POS* *REG* *RETAIL* *STORE* *TERM* The variant also appears to drop shadnewdll, a proxy module that intercepts and modi.es web traf.c on anaffected device to create fraudulent bank transactions over the network. Additionally, according to securityresearcher Brad Duncan, the module shares similarities with the banking trojan IcedID, which redirectsvictims to fake online banking sites or attaches to a browser process to inject fake content in phishingschemes. In such cases where the malware fails to connect, it will search for .les with the following extensions in theremovable and network drives. These extensions are .le types used by Microsoft Of.ce and OpenDocument: .doc .xls .pdf.rtf .txt .pub.odt .ods .odp.odm .odc .odb Files with the aforementioned extensions will be saved in the %Temp% folder as ascii.txt. The said .les will all then be deleted and replaced with a copy of the malware and the extension .jse (but is actually a JS .le). Figure 8. Scanning for .les and replacing it with a copy of itself Defending Against Trickbot: Trend Micro Recommendations and Solutions Information-stealing malware Trickbot has become a cybercriminal mainstay for infecting machines andcompromising emails, and has been used to reportedly steal more than 250 million accounts. This new development shows how cybercriminals can constantly tweak an existing banking trojan to add newcapabilities. Users, however, can prevent these attacks by simply following best practices against spam.Aside from awareness of the telltale signs of a spam email such as suspicious sender address and glaringgrammatical errors, we also recommend that users refrain from opening email attachments from unveri.ed sources. Users and enterprises can also bene.t from protection that uses a multilayered approach against risks broughtby threats like Trickbot. We recommend employing endpoint application control that reduces attack exposureby ensuring only .les, documents, and updates associated with whitelisted applications and sites can beinstalled, downloaded, and viewed. Endpoint solutions powered by XGenþ security such as Trend Microþ Security and Trend Micro Network Defense can detect related malicious .les and URLs and protect users¡¯systems. Trend Microþ Smart Protection Suites and Trend Micro Worry-Freeþ Business Security, whichhave behavior monitoring capabilities, can additionally protect from these types of threats by detectingmalicious .les such as the document and JS .le involved in this campaign, as well as blocking all relatedmalicious URLs. The Trend Micro Deep Discovery Inspector protects customers from threats that may lead to C&Cconnection and data ex.ltration via these DDI rules: 1645: Possible Self-Signed SSL certi.cate detected2780: TRICKBOT . HTTP (Request) Indicators of Compromise (IoCs) SHA-256 and URL Trend Micro Pattern Trend Micro NoteDetection Predictive Machine LearningDetection 0242ebb681eb1b3dbaa751320dea56e31c5e52c8324a7de125a8144cc5270698  TrojanSpy.Win32.TRICKBOT.TIGOCDC  TROJ.Win32.TRX.XXPE50FFF031  Trickbot  16429e95922c9521f7a40fa8f4c866444a060122448b243444dd2358a96a344c  Trojan.W97M.JASCREX.A  Downloader.VBA.TRX.XXVBAF01FF004  Document .le  666515eec773e200663fbd5fcad7109e9b97be11a83b41b8a4d73b7f5c8815ff  Trojan.W97M.JASCREX.AB  Downloader.VBA.TRX.XXVBAF01FF004  Document .le  41cd7fec5eaad44d2dba028164b9b9e2d1c6ea9d035679651b3b344542c40d45  Trojan.W97M.JASCREX.AD  Downloader.VBA.TRX.XXVBAF01FF004  Document .le  970b135b4c47c12f97bc3d3bbdf325f391b499d03fe19ac9313bcace3a1450d2  Trojan.W97M.JASCREX.AC  Document .le  8537d74885aed5cab758607e253a60433ef6410fd9b9b1c571ddabe6304bb68a 970b135b4c47c12f97bc3d3bbdf325f391b499d03fe19ac9313bcace3a1450d2  TrojanSpy.JS.NEMUCOD.BONINGH  Dropped JS .le(with .datextension) Spam email  hxxps://185[.]159[.]82[.]15/hollyhole/c644[.]php  Malicious URL  Check Point Research also tweeted about this campaign last July. Related Posts: From Fileless Techniques to Using Steganography: Examining Powload¡¯s EvolutionAnalysis: Abuse of Custom Actions in Windows Installer MSI to Run Malicious JavaScript,VBScript, and PowerShell ScriptsSpam Campaign Targets Colombian Entities with Custom-made ¡®Proyecto RAT,¡¯ Uses EmailService YOPmail for C&C Learn how to protect Enterprises, Small Businesses, and Home Users from ransomware: ENTERPRISE . SMALL BUSINESS . HOME . Tags: banking TrojanJavaScriptJSmacroMicrosoft Word Featured Stories systemd Vulnerability Leads to Denial of Service on LinuxqkG Filecoder: Self-Replicating, Document-Encrypting RansomwareMitigating CVE-2017-5689, an Intel Management Engine VulnerabilityA Closer Look at North Korea¡¯s Internet From Cybercrime to Cyberpropaganda Security Predictions for 2019 Our security predictions for 2019 are based on our experts¡¯ analysis of the progress of current andemerging technologies, user behavior, and market trends, and their impact on the threat landscape. Wehave categorized them according to the main areas that are likely to be affected, given the sprawlingnature of the technological and sociopolitical changes under consideration.Read our security predictions for 2019. Business Process Compromise Attackers are starting to invest in long-term operations that target speci.c processes enterprises rely on.They scout for vulnerable practices, susceptible systems and operational loopholes that they canleverage or abuse. To learn more, read our Security 101: Business Process Compromise. Recent Posts Mobile Cyberespionage Campaign Distributed Through CallerSpy Mounts Initial Phase of a TargetedAttack Operation ENDTRADE: Finding Multi-Stage Backdoors that TICKPatched GIF Processing Vulnerability CVE-2019-11932 Still Af.icts Multiple Mobile AppsMac Backdoor Linked to Lazarus Targets Korean UsersMore than a Dozen Obfuscated APT33 Botnets Used for Extreme Narrow Targeting Popular Posts Mac Backdoor Linked to Lazarus Targets Korean Users New Magecart Attack Delivered Through Compromised Advertising Supply Chain Microsoft November 2019 Patch Tuesday Reveals 74 Patches Before Major Windows Update Fake Photo Beauti.cation Apps on Google Play can Read SMS Veri.cation Code to TriggerWireless Application Protocol (WAP)/Carrier Billing New Exploit Kit Capesand Reuses Old and New Public Exploits and Tools, Blockchain Ruse Stay Updated |For Business |Security Intelligence|About Trend Micro Asia Paci.c Region (APAC): Australia / New Zealand, ÖÐ¹ú, .±¾, ...., Ì¨. Latin America Region (LAR): Brasil, M¨¦xico North America Region (NABU): United States, Canada Europe, Middle East, & Africa Region (EMEA): France, Deutschland / .sterreich / Schweiz, Italia,§²§à§ã§ã§Ú§ñ, Espa.a, United Kingdom / Ireland Privacy StatementLegal Policies Copyright ý 2019 Trend Micro Incorporated. All rights reserved. 