奇安信威胁情报中. ti.qianxin.com/blog/articles/english-version-of-new-approaches-utilized-by-oceanLotus-to-target.vietnamese-environmentalist The OceanLotus, an APT group said to have a Vietnamese background, was .rst exposed and named by SkyEye Labs (the predecessor of the RedDrip team of QiAnXin Threat Intelligence Center) in May 2015. Its attack activities can be traced back to April 2012 with initial targets including Chinese maritime institutions, maritime construction, scienti.c research institutes and shipping enterprises. Their targets expanded to almost all important organizations afterwards and related activities are still active now. The RedDrip Team (@RedDrip7) keeps a close eye on activities made by OceanLotus. Last month we released an in-depth analysis report: OceanLotus’ Attacks to Indochinese Peninsula: Evolution of Targets, Techniques and Procedure. Currently we capture another attack incident targeting a Vietnamese environmentalist with new malware payload and hope the revealed details could lead to more .ndings in the future. Bait Analysis The bait sample is a zip archive in Vietnamese: Th.ng tin v. chuyên .. m.i tr..ng_Nh. anh ..ng V. L..ng t. v.n thêm.zip From the contents of the compressed package, the three pictures named in Vietnamese meaning "illustration" respectively show that there is garbage in the rivers in Vietnam, the factories are exhausting smoke everywhere, and the stinking ditch is all garbage. All these pictures make people feel disgusting. At the same time, it shows the importance of mandatory waste classi.cation. In addition to the picture, the main attack sample is an hta script named as Van nan moi truong Viet Nam hien nay va giai phap khac phuc hau qua_Phuong huong trong thoi gian toi. It can be seen that both the bait name from the compressed package and the bait name as the attack sample are consistent with the scene of attacking the person in charge of the environmental protection organization. Therefore, we will characterize this attack as: Oceanlotus attacked the head of an environmental protection organization in Vietnam. Sample Analysis Execution process of the sample used by OceanLotus this time is roughly as follows: 1. The hta sample decrypts and loads subsequent additional data. 2. Utilize DLL Side-Loading to take advantage of adobe reader to load the payload and then connects to the C2. Payload Analysis The hta script has been obfuscated and will replace ",", ".", " " with "+", "/", "=" .rst: Name Value Description Parame.ter 1  163268915 0x6150DC03）  4-byte key, just use the .rst 3 bytes (0x03, 0xdc, 0x50)  Parame.ter 2  31529  The position at the end of the script, which points to theappended data.  Parame.ter 3  194  The length of the name of the released docx .le  Parame.1292962 Size of the appended datater 4 The second parameter is the beginning of the appended data: Loader Analysis The decrypted Loader module is named L.dll. The function of the dll is mainly to decrypt and load the appended data behind the hta: Figure 2.9 Loading Dll into memory by shellcode Subsequently released .les are stored in the resource, and the PE .le to be released is extracted from the resource data through RtlDecompressBuffer: Then get the exe and dll .le names in system32, Program File and Windows directory, insert them into the array, then randomly generate a random number, randomly select a .le in the array, get the .le name and .le description of the .le as the name of the dropped exe .le and related folder name respectively: The name of the exe .le is the name of the randomly selected .le. Rasman.db3 is the shellcode to be loaded. At the same time, an empty docx .le will be created under temp folder and then opened, so that the victim thinks that it is a docx .le: Thong tin chi tiet nhung san pham can dat hang qua shop zero waste_Bao gia chi tiet san pham.docx Figure 2.18 The created docx .le English translation of the .le name: The details information about products need order shop zero waste details price list Dropper Analysis The released rasman.exe is a legitimate .le: Adobe 3D Utility: MD5 File Name Size .ag Comment 9ca638ae.ACE.dll 11441Kb 0x8F Loader .lled with use.b4ce87936b1a993ef8e285fa less data 6/21/2019 奇安信威胁情报中.  0a9d3fff.f6083a015ab72117cba84fe0  AGM.dll  11441Kb  0x8F  Loader .lled with use.less data  840c754098c473faff6fd22d.db8163b7  BIB.dll  11441Kb  0x6D  Loader .lled with use.less data  a8ff3e6abe26c4ce72267154.ca604ce3  rasman.db3  910Kb  Shellcode .le with random name  e84927bc7e4be.f6af8daf8640d95325e  rasman.exe  246Kb  Legitimate executablewith random name  d7c72d9394dc6e519d.bce21830eb37cb  CoolType.dll  11441Kb  0x27  Loader .lled with use.less data, loadshellcode  f5220efbe14b98ac06bc2.cadef5c0f23  MSVCP80.dll  11441Kb  Library functions pop.ulated with useless data  321c4d24.MSVCR80.dll 11441Kb Library functions pop.da35f39c4ab145b6cfc4da19 ulated with useless data The code at the entrance of AGM.dll indicates the two if judgments will not enter, because the value of .ag is 0x8f, which is greater than the .rst two judgments, so the subsequent payload will not be loaded: The function of fun_LoadExportFun is mainly to cover large code at the entrance of exe, loop into the garbage code appearing in the con.guration, the size is 0x20610 bytes, then add the code 0xff, 0x15 at the end, and .nally connect the address of the export function of AGM_5, only In order to .nally execute the code that loads the shellcode: 1. Insert the encrypted data to the end of the hta script to avoid the existence of multiple .les. 2. The released .les are randomly named according to the .le name and .le description selected from the compromised computer, so as to avoid being easily acquired in forensics. 3. Only select one of the dll .les while performing DLL Side-Loading, and .ll the exe entry point with junk code and then do a jump operation to avoid stack traceback. 4. Enlarge the .le size to avoid being uploaded automatically. Conclusion The OceanLotus re.ects a very strong confrontational ability and willing to attack by keep evolving their techniques, including approaches to deliver bait documents, changes of the payloads, measures in circumvention, as well as domain assets, no matter the target is domestic or overseas. Due to the transnational nature of most APT groups, it is dif.cult to eliminate threats from the root cause. Therefore, tracking these APT attacks and adopting confrontation measures will exist for a long time. All we can do is to continuously improve our own discovery and containment capabilities, then will be able to overwhelming opponents technically. At present, all QiAnXin products can protect users from this new attack carried out by OceanLotus. IOC Bait Document 0dd468ee3a4ec0f6f84473bd8428a1e1 Loader b28c80ca9a3b7deb09b275af1076eb55 C2 udt.sophiahoule.com 