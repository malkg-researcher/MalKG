CyberThreatIntel / Indian / APT / Patchwork / 27-08-19 / Malware analysis 27-08-19.md StrangerealIntelUpdate Malwareanalysis27-08-19.md72f62e62daysago1contributor81 lines (74 sloc) 7.02 KBMalwareanalysisaboutsampleofAPTPatchworkTableofContentsMalwareanalysisInitialvectorCyberThreatIntelIndicatorsOfCompromise(IOC)ReferencesMITRE ATT&CK MatrixLinksOriginalTweetLinkAnyrunDocumentsMalwareanalysisInitialvectorTheinitialvectorisanINP file(formatusedforthesoftwareInPage)withtheexploitCVE-2017-12824,wecanseeherethe0x7E and0x72representaclassoftypeinthestreamforuse,anolestreamforlaunchthefirstbinaryfile.RawBlameHistory9/11/2019CyberThreatIntel/Malware analysis 27-08-19.md at master ， StrangerealIntel/CyberThreatIntel ， GitHubWecanseeonthestringsonthedll,whatextractthefileinthetempfolderandcreateathreadforthesecondPE file.OntheentrypointofthesecondPE,wecanseethefirstactionistochecktheenvironmentinusingtheanti-forensictechniquebytheCheckRemoteDebuggerPresentfunction.https://github.com/StrangerealIntel/CyberThreatIntel/blob/master/Indian/APT/Patchwork/27-08-19/Malware analysis 27-08-19.md 9/11/2019 CyberThreatIntel/Malware analysis 27-08-19.md at master ， StrangerealIntel/CyberThreatIntel ， GitHub Before go on the others function. We can see that the PE get the name of the user and create their persistence by an RunOnce key in the registry. (\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce Putty explorer.exe CurrentUser C:\file.exe) After this, this uses the CreateToolhelp32snapshot function for getting a snapshot of all the process an parsed it until this fall on the explorer process. We can note this check with the IsProcessorFeaturePresent function, for check if and raise an exception for close the program. https://github.com/StrangerealIntel/CyberThreatIntel/blob/master/Indian/APT/Patchwork/27-08-19/Malware analysis 27-08-19.md Once the check, this injects with a Process Hollowing for create a process for communicate with the C2 and wait to loader the next malware. 9/11/2019 CyberThreatIntel/Malware analysis 27-08-19.md at master ， StrangerealIntel/CyberThreatIntel ， GitHub At the date of the submission in VT, the C2 is down and the next step can't be analysed. Cyber kill chain The process graph resume the cyber kill chain used by the attacker. Cyber Threat Intel Firstly, we can observe that the payload seems be with the Professional version of Inpage (2.21). Inpage is currently used in Pakistan which is consistent with the fact that Patchwork is an Indian APT. Secondly, we can note the same pdb path what the 360TI analysis. The C2 is hosted on Amazon CloudFront : IP  Hostname  Route  ASN  Organiz  99.84.194.39  server-99-84-194.39.lax3.r.cloudfront.net  99.84.194.0/23  AS16509  Amazon Inc  This payload is linked at one of the recent events : https://github.com/StrangerealIntel/CyberThreatIntel/blob/master/Indian/APT/Patchwork/27-08-19/Malware analysis 27-08-19.md A Delegation of Pakistan Naval Academy visits Azerbaijan (5 April 2019) The visit of Pakistan Air Force Academy delegation in Azerbaijan (20 June 2019) References MITRE ATT&CK Matrix List of all the references with MITRE ATT&CK Matrix Enterprise tactics  Technics used  Ref URL  Execution  T1064 -Scripting  https://attack.mitre.org/techniques/T1064  Persistence  T1060 -Registry Run Keys / Startup Folder  https://attack.mitre.org/techniques/T1060  Defense Evasion  T1093 -Process Hollowing  https://attack.mitre.org/techniques/T1093  Discovery  T1087 -Account Discovery  https://attack.mitre.org/techniques/T1087  Note: INP exploit hasn't a current category, the most near category found matching with it is Scripting. Indicators Of Compromise (IOC) List of all the Indicators Of Compromise (IOC) Indicator  Description  Azerbaijan delegation to pakistan.inp  c0eeddccddbf23844c5e479a3dcc30713b697fa83d7c13feb79ecf  bin1.dll  078e316440a540ed8095d12f154770118e28ca67a32c0fcc514564  bin2.exe  67923d0e9717aec0930ed0e4a3f84b5ba00dee9fc64774be452ce  go.affec.tv  Domain requested  99.84.194.39  IP C2  go.affec.tv  Domain C2  This can be exported as JSON format Export in JSON Links Original tweet: https://twitter.com/jsoo/status/1166353584923041798 Links Anyrun: Azerbaijan delegation to pakistan.inp Documents: Recent InPage Exploits Lead to Multiple Malware Families InPage zero-day exploit used to attack financial institutions in Asia Analysis Of Targeted Attack Against Pakistan By Exploiting InPage Vulnerability And Related APT Groups The CheckRemoteDebuggerPresent() anti-debugging technique 